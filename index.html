<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>越南语-语法-排序练习</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding-bottom: 300px;
            background-color: #f7fbf3;
        }
        
        #gameContainer {
            min-height: calc(100vh - 150px);
        }
        
        #infoBox {
            width: 95%; 
            max-width: 700px;
            min-height: 100px; 
            margin: 0 auto; 
            border: 2px solid #72a9db; /*041b31 1f4263*/
            background: #63a0d8; /*ecf2e4 fefefc 63a0d8 */
            color: #ffffff; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: clamp(40px, 5vw, 60px);
            font-weight: bold;
        }
        
        #contactBox, #instructionBox {
            width: 90%;
            max-width: 700px;
            min-height: 25px;
            margin: 0px auto;
            border: 2px solid #72a9db;
            background: #63a0d8;
            color: #ffd300;
            padding-left: 20px;
            display: flex;
            align-items: center;
            font-size: clamp(16px, 2vw, 20px);
            font-weight: bold;
        }
        
        #instructionBox {
            color: #f7e19c;
        }

        #indicator, #indicator2 {
            width: 90%;
            max-width: 700px;
            min-height: 70px;
            margin: 15px auto;
            padding: 15px;
            border: 3px solid #fed16a;
            background: #ffffe0;
            border-radius: 5px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            align-items: center;
            font-size: clamp(32px, 5vw, 48px);
            font-weight: bold;
        }
        
        #indicator2 {
            background: #fffbef;
            border: 3px solid #ccc;
            min-height: 90px;
            transition: all .4s;
        }
        
        #indicator2.correct {
            background: #B7D7AA !important;
            border-color: #5ba346;
        }
        
        #indicator2.wrong {
            background: #ffcccc !important;
            border-color: #CE6D5E;
        }

        .word-btn {
            padding: 10px 20px;
            background: #fff;
            border: 2px solid #63a0d8;
            border-radius: 12px;
            font-size: clamp(32px, 5vw, 48px);
            cursor: pointer;
            user-select: none;
            box-shadow: 0 3px 6px rgba(0,0,0,.15);
            transition: all .2s;
            min-width: 60px;
            text-align: center;
        }
        
        .word-btn.used {
            opacity: 0.35;
            pointer-events: none;
        }
        
        .word-btn-in-answer {
            background: #ffd700 !important;
            animation: pop .3s;
        }
        
        @keyframes pop {
            0% { transform: scale(0.8); }
            100% { transform: scale(1); }
        }

        #optionsPool {
            width: 95%;
            max-width: 700px;
            margin: 20px auto;
            padding: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }

        #controls {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 95%;
            max-width: 800px;
            background: #f7fbf3;
            padding: 10px 0;
            z-index: 1000;
        }
        
        button {
            padding: 8px 12px;
            margin: 2px 3px;
            cursor: pointer;
            border: 2px solid #63a0d8;
            background: #63a0d8;
            color: #fffbef;
            font-size: 28px;
            border-radius: 5px;
        }
        
        .active-mode {
            border: 2px solid #fed16a;
        }
        
        .disabled {
            opacity: 0.6;
            pointer-events: none;
        }

        #results, #score {
            width: 95%;
            max-width: 700px;
            margin: 20px auto;
            padding: 15px;
            border-radius: 10px;
            font-size: 28px;
            display: none;
        }
        
        #results {
            border: 2px solid #734A2E;
            background: #fffbef;
        }
        
        #score {
            color: #FF6820;
            background: #fffbef;
            border: 2px solid #FF6820;
        }
                #sentenceNumber {
                        width: 70px;
                        height: 30px;
                        text-align: center;
                        font-size: 20px;
                        border: 2px solid #63a0d8;
                        border-radius: 5px;
                        margin: 0 5px;
                }
        @media (max-width: 768px) {
            body {
                padding-bottom: 220px;
            }
            
            button {
                font-size: 20px;
            }
            
            .word-btn {
                font-size: 28px;
                padding: 8px 14px;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="infoBox">习得越南语<br>语法 - 排序练习</div>
        <div id="contactBox">讲师-阮玉煌 | Weixin：XiDeYueNanYu</div>
        <div id="instructionBox">把词语按正确顺序排列 → 听原音</div>

        <div id="indicator"></div>
        <div id="indicator2"></div>
        <div id="optionsPool"></div>

        <div id="results"></div>
        <div id="score">0/0</div>
    </div>

    <div id="controls">
        <div>
            <button id="freeModeBtn" class="active-mode">自由模式</button>
            <button id="testModeBtn">作业模式</button>
        </div>
        <div>
            <button id="autoContinueBtn">自动继续</button>
            <button id="showHideBtn">显示-隐藏</button>
        </div>
        <div>
            <button id="prevBtn">◀</button>
            <input type="text" id="sentenceNumber" inputmode="numeric">
            <button id="nextBtn">▶</button>
            <button id="replayBtn">再听一遍</button>
        </div>
    </div>

    <audio id="mainAudio"></audio>
    <audio id="correctAudio" src="Dung.mp3"></audio>
    <audio id="wrongAudio" src="Sai.mp3"></audio>

    <script>

const sentences = [
    {
        "audioFile": "audio.mp3",
        "start": 0,
        "end": 2.46,
        "correctAnswer": "【Em】【có】【biết】【nấu】【món ăn】【Việt Nam】【không?】",
        "translation": "你会做越南菜吗？"
    },
    {
        "audioFile": "audio.mp3",
        "start": 4.31,
        "end": 6.08,
        "correctAnswer": "【Anh】【có】【biết】【chị ấy】【không?】",
        "translation": "你认识她吗？"
    },
    {
        "audioFile": "audio.mp3",
        "start": 8.05,
        "end": 9.79,
        "correctAnswer": "【Anh】【không】【biết】【chị ấy】.",
        "translation": "我不认识她。"
    },
    {
        "audioFile": "audio.mp3",
        "start": 11.75,
        "end": 14.03,
        "correctAnswer": "【Có phải】【chị】【biết】【nói】【tiếng Việt】【không?】",
        "translation": "你会说越南语，对吗？"
    },
    {
        "audioFile": "audio.mp3",
        "start": 15.81,
        "end": 17.53,
        "correctAnswer": "【Chị】【biết】【một】【chút】【tiếng Việt】",
        "translation": "我会一点越南语。"
    },
    {
        "audioFile": "audio.mp3",
        "start": 19.94,
        "end": 22.01,
        "correctAnswer": "【Anh】【biết】【nói】【tiếng Trung】【phải không?】",
        "translation": "你会说中文，对吗？"
    },
    {
        "audioFile": "audio.mp3",
        "start": 23.7,
        "end": 25.21,
        "correctAnswer": "【Mình】【biết】【anh ấy】.",
        "translation": "我认识他。"
    },
    {
        "audioFile": "audio.mp3",
        "start": 27.08,
        "end": 28.71,
        "correctAnswer": "【Mình】【biết】【cuốn sách ấy】.",
        "translation": "我知道那本书。"
    },
    {
        "audioFile": "audio.mp3",
        "start": 30.61,
        "end": 32.67,
        "correctAnswer": "【Em】【có】【biết】【chơi】【cầu lông】【không?】",
        "translation": "你会打羽毛球吗？"
    },
    {
        "audioFile": "audio.mp3",
        "start": 34.3,
        "end": 36.52,
        "correctAnswer": "【Không,】【em】【không】【biết】【chơi】.",
        "translation": "不，我不会玩。"
    },
    {
        "audioFile": "audio.mp3",
        "start": 38.15,
        "end": 39.86,
        "correctAnswer": "【Anh】【biết】【quán ăn ấy】.",
        "translation": "我知道那家餐馆。"
    },
    {
        "audioFile": "audio.mp3",
        "start": 41.5,
        "end": 43.3,
        "correctAnswer": "【Tớ】【biết】【công ty】【ấy】.",
        "translation": "我知道那家公司。"
    },
    {
        "audioFile": "audio.mp3",
        "start": 44.51,
        "end": 46.35,
        "correctAnswer": "【Tớ】【đã】【ăn tối】【rồi】.",
        "translation": "我已经吃晚饭了。"
    },
    {
        "audioFile": "audio.mp3",
        "start": 47.56,
        "end": 49.14,
        "correctAnswer": "【Bạn】【đã】【ăn tối】【chưa?】",
        "translation": "你吃晚饭了吗？"
    },
    {
        "audioFile": "audio.mp3",
        "start": 50.6,
        "end": 52.83,
        "correctAnswer": "【Chưa,】【mình】【chưa】【ăn tối】.",
        "translation": "还没，我还没吃晚饭。"
    },
    {
        "audioFile": "audio.mp3",
        "start": 54.43,
        "end": 56.37,
        "correctAnswer": "【Anh】【đã】【xem】【bộ phim】【này】【chưa?】",
        "translation": "你看过这部电影吗？"
    },
    {
        "audioFile": "audio.mp3",
        "start": 58.21,
        "end": 59.96,
        "correctAnswer": "【Chị】【đã】【nấu】【cơm】【chưa?】",
        "translation": "你煮饭了吗？"
    },
    {
        "audioFile": "audio.mp3",
        "start": 61.31,
        "end": 63.55,
        "correctAnswer": "【Chưa,】【chị】【chưa】【nấu】.",
        "translation": "还没，我还没煮。"
    },
    {
        "audioFile": "audio.mp3",
        "start": 65.05,
        "end": 66.88,
        "correctAnswer": "【Bạn】【dạy】【mình】【tiếng Việt】【nhé!?】",
        "translation": "你教我越南语吧！？"
    },
    {
        "audioFile": "audio.mp3",
        "start": 68.7,
        "end": 70.43,
        "correctAnswer": "【Chúng ta】【đi】【ăn sáng】【nhé!?】",
        "translation": "我们去吃早餐吧！？"
    },
    {
        "audioFile": "audio.mp3",
        "start": 72.12,
        "end": 73.99,
        "correctAnswer": "【Mọi người】【uống】【cà phê】【nhé!?】",
        "translation": "大家喝咖啡吧！？"
    },
    {
        "audioFile": "audio.mp3",
        "start": 75.84,
        "end": 78.39,
        "correctAnswer": "【Trời】【mưa】【rồi,】【em】【lấy】【quần áo】【nhé!?】",
        "translation": "下雨了，你去收衣服吧！？"
    },
    {
        "audioFile": "audio.mp3",
        "start": 80.5,
        "end": 82.32,
        "correctAnswer": "【Hôm nay】【thời tiết】【đẹp】【nhỉ!】",
        "translation": "今天天气很好呢！"
    },
    {
        "audioFile": "audio.mp3",
        "start": 83.62,
        "end": 85.83,
        "correctAnswer": "【Ừ,】【thời tiết】【đẹp】【quá!】",
        "translation": "嗯，天气真好啊！"
    },
    {
        "audioFile": "audio.mp3",
        "start": 87.02,
        "end": 88.62,
        "correctAnswer": "【Anh ấy】【đẹp trai】【nhỉ!】",
        "translation": "他很帅呢！"
    },
    {
        "audioFile": "audio.mp3",
        "start": 90.41,
        "end": 91.66,
        "correctAnswer": "【Cũng】【bình thường】.",
        "translation": "也很普通。"
    },
    {
        "audioFile": "audio.mp3",
        "start": 93.14,
        "end": 94.86,
        "correctAnswer": "【Bạn】【nói】【tiếng Việt】【giỏi】【nhỉ!】",
        "translation": "你越南语说得很好呢！"
    },
    {
        "audioFile": "audio.mp3",
        "start": 95.83,
        "end": 98.15,
        "correctAnswer": "【Dạ,】【em】【biết】【một chút】【tiếng Việt】.",
        "translation": "好，我会一点越南语。"
    }
];

        let currentIndex = 0;
        let isFreeMode = true;
        let autoContinue = false;
        let showTranslation = true;
        let correctCount = 0;
        let userAnswers = [];
        let selectedWords = [];
        let isChecking = false;
        let isAudioPlaying = false;

        const audio = document.getElementById('mainAudio');
        const correctAudio = document.getElementById('correctAudio');
        const wrongAudio = document.getElementById('wrongAudio');
        const indicator = document.getElementById('indicator');
        const indicator2 = document.getElementById('indicator2');
        const optionsPool = document.getElementById('optionsPool');
        const sentenceNumber = document.getElementById('sentenceNumber');
        const scoreDisplay = document.getElementById('score');
        const resultsDisplay = document.getElementById('results');

        function init() {
            userAnswers = new Array(sentences.length).fill(null);
            updateDisplay();
        }

        function updateDisplay() {
            sentenceNumber.value = currentIndex + 1;
            const s = sentences[currentIndex];
            
            if (showTranslation) {
                indicator.innerHTML = `<div style="color:#63a0d8;font-size:0.6em;">${s.translation}</div>`;
            } else {
                indicator.innerHTML = '';
            }

            const words = s.correctAnswer.match(/【(.*?)】/g).map(t => t.slice(1,-1));
            const shuffled = shuffleArray(words);

            optionsPool.innerHTML = '';
            indicator2.innerHTML = '';
            indicator2.className = '';
            selectedWords = [];
            isChecking = false;

            shuffled.forEach(word => {
                const btn = document.createElement('div');
                btn.className = 'word-btn';
                btn.textContent = word;
                btn.onclick = () => selectWord(word, btn);
                optionsPool.appendChild(btn);
            });

            document.getElementById('prevBtn').classList.toggle('disabled', !isFreeMode && currentIndex === 0);
        }

        function selectWord(word, btn) {
            if (btn.classList.contains('used')) {
                const idx = selectedWords.indexOf(word);
                if (idx > -1) {
                    selectedWords.splice(idx, 1);
                    btn.classList.remove('used');
                    renderAnswerArea();
                }
                return;
            }

            selectedWords.push(word);
            btn.classList.add('used');
            renderAnswerArea();

            indicator2.classList.remove('correct', 'wrong');
            
            if (selectedWords.length === getCorrectWords().length && !isChecking) {
                isChecking = true;
                setTimeout(checkAnswer, 400);
            }
        }

        function renderAnswerArea() {
            indicator2.innerHTML = '';
            selectedWords.forEach((word, i) => {
                const btn = document.createElement('div');
                btn.className = 'word-btn word-btn-in-answer';
                btn.textContent = word;
                btn.onclick = () => {
                    selectedWords.splice(i, 1);
                    renderAnswerArea();
                    Array.from(optionsPool.children).find(b => b.textContent === word)?.classList.remove('used');
                    isChecking = false;
                    indicator2.classList.remove('correct', 'wrong');
                };
                indicator2.appendChild(btn);
            });
        }

        function getCorrectWords() {
            return sentences[currentIndex].correctAnswer.match(/【(.*?)】/g).map(t => t.slice(1,-1));
        }

        function getCorrectAnswerWithSpaces() {
            const words = getCorrectWords();
            return words.join(' ');
        }

        function checkAnswer() {
            const userStr = selectedWords.join('');
            const correctStr = getCorrectWords().join('');
            const isCorrect = userStr === correctStr;

            if (!isFreeMode && userAnswers[currentIndex] === null) {
                userAnswers[currentIndex] = selectedWords.join(' ');
                if (isCorrect) correctCount++;
                updateScore();
            }

            if (isCorrect) {
                indicator2.classList.add('correct');
                indicator2.classList.remove('wrong');
                correctAudio.play();
                playOriginalSentenceExactly();
            } else {
                indicator2.classList.add('wrong');
                wrongAudio.play();
                
                // Trong chế độ 作业模式, phát âm thanh ngay cả khi sai
                if (!isFreeMode) {
                    playOriginalSentenceExactly();
                }
            }

            const delay = 1200;
            
            const moveToNextSentence = () => {
                if (isFreeMode) {
                    if (autoContinue && isCorrect) {
                        nextSentence();
                    }
                } else {
                    if (currentIndex < sentences.length - 1) {
                        currentIndex++;
                        updateDisplay();
                    } else {
                        showFinalResults();
                    }
                }
            };
            
            setTimeout(() => {
                if (!isAudioPlaying) {
                    moveToNextSentence();
                } else {
                    const checkAudioEnd = setInterval(() => {
                        if (!isAudioPlaying) {
                            clearInterval(checkAudioEnd);
                            moveToNextSentence();
                        }
                    }, 100);
                }
            }, delay);
        }

        function playOriginalSentenceExactly() {
            const s = sentences[currentIndex];
            audio.src = s.audioFile;
            audio.currentTime = s.start;
            isAudioPlaying = true;
            audio.play();

            const stopAtEnd = () => {
                if (audio.currentTime >= s.end) {
                    audio.pause();
                    isAudioPlaying = false;
                    audio.removeEventListener('timeupdate', stopAtEnd);
                }
            };
            audio.addEventListener('timeupdate', stopAtEnd);
            
            audio.addEventListener('ended', () => {
                isAudioPlaying = false;
            });
        }

        document.getElementById('replayBtn').onclick = playOriginalSentenceExactly;

        function showFinalResults() {
            let text = `练习完成！\n正确：${correctCount}/${sentences.length}（${(correctCount/sentences.length*100).toFixed(1)}%）\n\n`;
            
            let hasWrong = false;
            let wrongQuestionsText = "错题回顾：\n";
            
            for (let i = 0; i < sentences.length; i++) {
                const correctWords = getCorrectWordsFromSentence(sentences[i]);
                const correctAnswerWithSpaces = correctWords.join(' ');
                
                if (userAnswers[i] && userAnswers[i] !== correctAnswerWithSpaces) {
                    hasWrong = true;
                    wrongQuestionsText += `${i+1}. ${sentences[i].translation}\n   你的答案: ${userAnswers[i]}\n   正确答案: ${correctAnswerWithSpaces}\n\n`;
                }
            }
            
            if (hasWrong) {
                text += wrongQuestionsText;
            } else {
                text += "全对！太厉害了！";
            }
            
            resultsDisplay.textContent = text;
            resultsDisplay.style.display = 'block';
            scoreDisplay.style.display = 'none';
        }

        function getCorrectWordsFromSentence(sentence) {
            return sentence.correctAnswer.match(/【(.*?)】/g).map(t => t.slice(1,-1));
        }

        function updateScore() {
            scoreDisplay.textContent = `${correctCount}/${sentences.length}`;
        }

        function nextSentence() {
            if (currentIndex < sentences.length - 1) {
                currentIndex++;
                updateDisplay();
            } else if (isFreeMode) {
                currentIndex = 0;
                updateDisplay();
            }
        }

        function prevSentence() {
            if (currentIndex > 0) {
                currentIndex--;
                updateDisplay();
            } else if (isFreeMode) {
                currentIndex = sentences.length - 1;
                updateDisplay();
            }
        }

        function shuffleArray(a) {
            const arr = [...a];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        document.getElementById('freeModeBtn').onclick = () => {
            isFreeMode = true;
            document.getElementById('freeModeBtn').classList.add('active-mode');
            document.getElementById('testModeBtn').classList.remove('active-mode');
            scoreDisplay.style.display = 'none';
            resultsDisplay.style.display = 'none';
            updateDisplay();
        };

        document.getElementById('testModeBtn').onclick = () => {
            isFreeMode = false;
            document.getElementById('testModeBtn').classList.add('active-mode');
            document.getElementById('freeModeBtn').classList.remove('active-mode');
            scoreDisplay.style.display = 'block';
            resultsDisplay.style.display = 'none';
            currentIndex = 0;
            correctCount = 0;
            userAnswers = new Array(sentences.length).fill(null);
            updateDisplay();
        };

        document.getElementById('prevBtn').onclick = () => {
            if (isFreeMode) {
                prevSentence();
            } else if (currentIndex > 0) {
                currentIndex--;
                updateDisplay();
            }
        };
        
        document.getElementById('nextBtn').onclick = () => {
            if (isFreeMode) {
                nextSentence();
            } else if (currentIndex < sentences.length - 1) {
                currentIndex++;
                updateDisplay();
            }
        };

        document.getElementById('autoContinueBtn').onclick = () => {
            autoContinue = !autoContinue;
            document.getElementById('autoContinueBtn').classList.toggle('active-mode', autoContinue);
        };

        document.getElementById('showHideBtn').onclick = () => {
            showTranslation = !showTranslation;
            document.getElementById('showHideBtn').classList.toggle('active-mode', showTranslation);
            updateDisplay();
        };

        sentenceNumber.onchange = () => {
            if (isFreeMode) {
                const n = parseInt(sentenceNumber.value) - 1;
                if (n >= 0 && n < sentences.length) { 
                    currentIndex = n; 
                    updateDisplay(); 
                }
            }
        };

        init();
    </script>
</body>
</html>